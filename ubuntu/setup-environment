#!/bin/bash

log() {
    echo "[`date '+%Y-%m-%d %H:%M:%S'`] $1"
}

log "Starting environment setup..."


if command -v readlink >/dev/null 2>&1 && readlink -f / >/dev/null 2>&1; then
  SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
else
  # Fallback for systems without readlink -f (like macOS)
  SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
fi

SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
log "Script directory resolved to: $SCRIPT_DIR"

export PATH="$SCRIPT_DIR:$PATH"
log "Updated PATH to include script directory."

VENV_DIR="$SCRIPT_DIR/qenv"
log "Virtual environment directory set to: $VENV_DIR"

if [ ! -d "$VENV_DIR" ]; then
    log "Virtual environment not found. Creating one..."
    python3 -m venv "$VENV_DIR"
    log "Virtual environment created."
else
    log "Virtual environment already exists."
fi

log "Activating virtual environment..."
. "$VENV_DIR/bin/activate"
log "Virtual environment activated."

REQ_FILE="$SCRIPT_DIR/requirements.txt"
if [ -f "$REQ_FILE" ]; then
    log "Checking for missing dependencies in requirements.txt..."
    missing=$("$VENV_DIR/bin/pip" install --dry-run --requirement "$REQ_FILE" 2>/dev/null | grep "Would install" || true)

    if [ -n "$missing" ]; then
        log "Missing dependencies detected:"
        echo "$missing" | sed 's/^.*Would install //' | tr ' ' '\n' | sort | uniq
        log "Installing missing dependencies..."
        "$VENV_DIR/bin/pip" install -r "$REQ_FILE" --quiet
        log "Dependencies installed."
    else
        log "All dependencies already satisfied."
    fi
else
    log "No requirements.txt found. Skipping dependency installation."
fi

log "Setup complete."
echo "qubuild is ready. Run \"qubuild --help\" for more info."
echo "add-changelog is ready. Run \"add-changelog --help\" for more info."

