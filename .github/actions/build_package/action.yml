name: Build Debian Package
description: |
  This Github Actions builds the package

inputs:
  pkg-dir:
    description: The directory where the debian package source is
    required: true
  build-dir:
    description: The directory where the package is built
    required: true
  run-lintian:
    description: Run lintian or not during the build
    default: false

runs:
  using: "composite"
  
  steps:
    - name : List All The Versions Of The Built Packages Contained In The Staging PPA
      shell: bash
      run: |
        cd ${{inputs.pkg-dir}}

        if [[ "${{inputs.run-lintian}}" == "true" ]]; then
          lintian_flag="--run-lintian"
        else
          lintian_flag="--no-run-lintian"
        fi

        if curl -sfI "http://pkg.qualcomm.com/dists/${{env.UBUNTU_CODENAME}}/Release" > /dev/null; then
          EXTRA_REPO="--extra-repository='deb [arch=${{env.ARCH}} trusted=yes] http://pkg.qualcomm.com ${{env.UBUNTU_CODENAME}}/stable main'"
        else
          EXTRA_REPO=""
        fi

        set +e
        gbp buildpackage \
          --git-ignore-branch \
          --git-builder="sbuild --arch=${{env.ARCH}} \
                                --dist=${{env.UBUNTU_CODENAME}}-${{env.ARCH}}-${{env.DISTRO}} \
                                $lintian_flag \
                                --build-dir ../build-area \
                                --build-dep-resolver=apt \
                                $EXTRA_REPO"

        RET=$?

        if (( RET == 0 )); then
          echo "✅ Successfully built package"
        else
          BUILD_LOG=$(find ../build-area -maxdepth 1 -name "*.build" ! -type l)

          if [[ -n "$BUILD_LOG" ]]; then
            tail -n 500 "$BUILD_LOG"
            echo "❌ Build failed, printed the last 500 lines of the build log file"
          else
            echo "❌ Build failed, but no .build log file was found to print"
          fi

          exit 1
        fi
